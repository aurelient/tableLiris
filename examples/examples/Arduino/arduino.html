<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Arduino.js</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
    </head>
    <body>
        <div style="position: relative;">
            <canvas id="tuioCanvas" width="1680" height="645" style="position: absolute; left: 0; top: 0; z-index: 1;"></canvas>
            <canvas id="fixe" width="1680" height="645" style="position: absolute; left : 0; top: 0; z-index: 0;"></canvas>
        </div>
        <script src="../../libs/prototype-1.6.0.2.js"></script>
        <script src="../../libs/jquery-1.7.2.js"></script>
        <script src="../../libs/requestanimationframe.js"></script>
        <script src='../../js/box2d/common/b2Settings.js'></script>
        <script src='../../js/box2d/common/math/b2Vec2.js'></script>
        <script src='../../js/box2d/common/math/b2Mat22.js'></script>
        <script src='../../js/box2d/common/math/b2Math.js'></script>
        <script src='../../js/box2d/collision/b2AABB.js'></script>
        <script src='../../js/box2d/collision/b2Bound.js'></script>
        <script src='../../js/box2d/collision/b2BoundValues.js'></script>
        <script src='../../js/box2d/collision/b2Pair.js'></script>
        <script src='../../js/box2d/collision/b2PairCallback.js'></script>
        <script src='../../js/box2d/collision/b2BufferedPair.js'></script>
        <script src='../../js/box2d/collision/b2PairManager.js'></script>
        <script src='../../js/box2d/collision/b2BroadPhase.js'></script>
        <script src='../../js/box2d/collision/b2Collision.js'></script>
        <script src='../../js/box2d/collision/Features.js'></script>
        <script src='../../js/box2d/collision/b2ContactID.js'></script>
        <script src='../../js/box2d/collision/b2ContactPoint.js'></script>
        <script src='../../js/box2d/collision/b2Distance.js'></script>
        <script src='../../js/box2d/collision/b2Manifold.js'></script>
        <script src='../../js/box2d/collision/b2OBB.js'></script>
        <script src='../../js/box2d/collision/b2Proxy.js'></script>
        <script src='../../js/box2d/collision/ClipVertex.js'></script>
        <script src='../../js/box2d/collision/shapes/b2Shape.js'></script>
        <script src='../../js/box2d/collision/shapes/b2ShapeDef.js'></script>
        <script src='../../js/box2d/collision/shapes/b2BoxDef.js'></script>
        <script src='../../js/box2d/collision/shapes/b2CircleDef.js'></script>
        <script src='../../js/box2d/collision/shapes/b2CircleShape.js'></script>
        <script src='../../js/box2d/collision/shapes/b2MassData.js'></script>
        <script src='../../js/box2d/collision/shapes/b2PolyDef.js'></script>
        <script src='../../js/box2d/collision/shapes/b2PolyShape.js'></script>
        <script src='../../js/box2d/dynamics/b2Body.js'></script>
        <script src='../../js/box2d/dynamics/b2BodyDef.js'></script>
        <script src='../../js/box2d/dynamics/b2CollisionFilter.js'></script>
        <script src='../../js/box2d/dynamics/b2Island.js'></script>
        <script src='../../js/box2d/dynamics/b2TimeStep.js'></script>
        <script src='../../js/box2d/dynamics/contacts/b2ContactNode.js'></script>
        <script src='../../js/box2d/dynamics/contacts/b2Contact.js'></script>
        <script src='../../js/box2d/dynamics/contacts/b2ContactConstraint.js'></script>
        <script src='../../js/box2d/dynamics/contacts/b2ContactConstraintPoint.js'></script>
        <script src='../../js/box2d/dynamics/contacts/b2ContactRegister.js'></script>
        <script src='../../js/box2d/dynamics/contacts/b2ContactSolver.js'></script>
        <script src='../../js/box2d/dynamics/contacts/b2CircleContact.js'></script>
        <script src='../../js/box2d/dynamics/contacts/b2Conservative.js'></script>
        <script src='../../js/box2d/dynamics/contacts/b2NullContact.js'></script>
        <script src='../../js/box2d/dynamics/contacts/b2PolyAndCircleContact.js'></script>
        <script src='../../js/box2d/dynamics/contacts/b2PolyContact.js'></script>
        <script src='../../js/box2d/dynamics/b2ContactManager.js'></script>
        <script src='../../js/box2d/dynamics/b2World.js'></script>
        <script src='../../js/box2d/dynamics/b2WorldListener.js'></script>
        <script src='../../js/box2d/dynamics/joints/b2JointNode.js'></script>
        <script src='../../js/box2d/dynamics/joints/b2Joint.js'></script>
        <script src='../../js/box2d/dynamics/joints/b2JointDef.js'></script>
        <script src='../../js/box2d/dynamics/joints/b2DistanceJoint.js'></script>
        <script src='../../js/box2d/dynamics/joints/b2DistanceJointDef.js'></script>
        <script src='../../js/box2d/dynamics/joints/b2Jacobian.js'></script>
        <script src='../../js/box2d/dynamics/joints/b2GearJoint.js'></script>
        <script src='../../js/box2d/dynamics/joints/b2GearJointDef.js'></script>
        <script src='../../js/box2d/dynamics/joints/b2MouseJoint.js'></script>
        <script src='../../js/box2d/dynamics/joints/b2MouseJointDef.js'></script>
        <script src='../../js/box2d/dynamics/joints/b2PrismaticJoint.js'></script>
        <script src='../../js/box2d/dynamics/joints/b2PrismaticJointDef.js'></script>
        <script src='../../js/box2d/dynamics/joints/b2PulleyJoint.js'></script>
        <script src='../../js/box2d/dynamics/joints/b2PulleyJointDef.js'></script>
        <script src='../../js/box2d/dynamics/joints/b2RevoluteJoint.js'></script>
        <script src='../../js/box2d/dynamics/joints/b2RevoluteJointDef.js'></script>
        <script src='../../libs/draw_world.js'></script>
        <script src="../../libs/lodash.js"></script>
        <script src="../../libs/socket.io.js"></script>
        <script src="../../dist/Tuio.js"></script>
        <script src="../../dist/hammer.js"></script>
        <script src="../../dist/Pattern.js"></script>
        <script src="../../dist/Shape.js"></script>
        <script src="../../dist/Circle.js"></script>
        <script src="../../dist/Rectangle.js"></script>
        <script src="../../dist/Manager.js"></script>

        <script>
            $.noConflict();
            jQuery(document).ready(function($) {
                Hammer.plugins.fakeMultitouch();
                var client = new Tuio.Client({
                    host: "http://localhost:5000"
                }),
                screenW = $(window).width(),
                screenH = $(window).height(),
                manager = new Manager(),
                canvasForeground = null, 
                canvasBackground = null,
                contextForeground = null,
                contextBackground = null;
                var socket = io.connect("127.0.0.1:1337");
                var msg = 'F';
                var sens = 'F';
                var def = new Pattern();
                var goal = new Pattern();
                var objX = 800;
                var objY = 200;
                var wheelPosX1 = -1;
                var wheelPosY1 = -1;
                var wheelPosX2 = -1;
                var wheelPosY2 = -1;
                var wheelAngle = 0;

                // Gesture recognition function
                gesture = function(event) {
                },

                // Init function
                onConnect = function() {
                    // Canvas Init
                    console.log("onConnect");
                    canvasForeground = $("#tuioCanvas").get(0);
                    canvasForeground.width=screenW;
                    canvasForeground.height=screenH;
                    canvasBackground = $("#fixe").get(0);
                    canvasBackground.width=screenW;
                    canvasBackground.height=screenH;
                    time = new Date().getTime();
                    contextForeground = canvasForeground.getContext("2d");
                    contextBackground = canvasBackground.getContext("2d");

                    manager.addPattern(def);
                    goal.addSizeLimit(1300,300);
                    //Manager Init
                    manager.setScreenSize(screenW, screenH);
                    manager.setOnGesture(gesture);
                    manager.initPhysics();

                    // Fill the screen with black
                    contextBackground.fillStyle = "#000000";
                    contextBackground.fillRect(0, 0, canvasBackground.width, canvasBackground.height);

                    draw();
                };

                // Draw the objects
                draw = function() {
                    contextForeground.clearRect(0, 0, canvasForeground.width, canvasForeground.height);

                    var blobs = client.getTuioBlobs(); 

                    var blob1 = null;
                    var blob2 = null;

                    for (var i in blobs) {
                        if (manager.blobMatchPattern(blobs[i],goal)) {
                            blobs[i].setColor("#0000FF");
                            objX = blobs[i].getScreenX(screenW);
                            objY = blobs[i].getScreenY(screenH);
                        } else {
                            if (blob1 == null) {
                                blob1 = blobs[i];
                            } else if (blob2 == null) {
                                blob2 = blobs[i];
                            }
                        }
                        
                        blobs[i].setContext(contextForeground);
                        /*msg = "";

                        if (blobs[i].getAngle() != null) {
                            if (blobs[i].getAngle() > 45 && blobs[i].getAngle() < 70) {
                                msg = 'R';
                            } else if (blobs[i].getAngle() > 20 && blobs[i].getAngle() < 45) {
                                msg = 'L';
                            } 
                        }

                        if (msg == "") {

                                msg = 'F';
                                sens = msg;
                            } else if (blobs[i].getX() > 0.8) {
                                msg = 'B';
                                sens = msg;
                            }
                        }

                        if (msg == "") {
                            msg = sens;
                        }

                        
                        socket.emit(msg, "");*/
                    }

                    var XBarycentre = 0;
                    var YBarycentre = 0;
                    msg = 'S';
                    if (blob1 != null && blob2 != null) {
                        contextForeground.save();
                        contextForeground.strokeStyle = "#FF0000";
                        contextForeground.beginPath();
                        contextForeground.moveTo(blob1.getScreenX(screenW),blob1.getScreenY(screenH));
                        contextForeground.lineTo(blob2.getScreenX(screenW), blob2.getScreenY(screenH));
                        contextForeground.stroke();
                        contextForeground.restore();

                        if (blob1.getScreenX(screenW) > blob2.getScreenX(screenW)) {
                            XBarycentre = blob1.getScreenX(screenW) + (blob2.getScreenX(screenW) - blob1.getScreenX(screenW)) / 2;
                        } else {
                            XBarycentre = blob1.getScreenX(screenW) + (blob2.getScreenX(screenW) - blob1.getScreenX(screenW)) / 2;
                        }
                        if (blob1.getScreenY(screenH) > blob2.getScreenY(screenH)){
                            YBarycentre = blob1.getScreenY(screenH) + (blob2.getScreenY(screenH) - blob1.getScreenY(screenH)) / 2;
                        } else {
                            YBarycentre = blob1.getScreenY(screenH) + (blob2.getScreenY(screenH) - blob1.getScreenY(screenH)) / 2;
                        }

                        if (objX == XBarycentre) {
                            angleObj = 0;
                        } else {
                            angleObj = Math.atan((YBarycentre - objY) / (objX - XBarycentre)) / Math.PI * 180;
                        }
                        console.log("pos : " + objX + " " + objY + " " + XBarycentre + " " + YBarycentre);
                            console.log((YBarycentre - objY) + " " + (objX - XBarycentre));

                        if (blob1.getArea() > blob2.getArea()) {
                            blob1.setColor("#FFFF00");
                            blob2.setColor("#FFFFFF");
                            if (blob2.getScreenX(screenW) == blob1.getScreenX(screenW)) {
                                angleRob = 0;
                            } else {
                                angleRob = Math.atan((blob1.getScreenY(screenH) - blob2.getScreenY(screenH)) / (blob2.getScreenX(screenW) - blob1.getScreenX(screenW))) / Math.PI * 180; 
                            }

                            wheelAngle = angleRob;

                            console.log("posRob " + blob1.getScreenX(screenW)  + " " + blob1.getScreenY(screenH) + " " + blob2.getScreenX(screenW) + " " + blob2.getScreenY(screenH))

                            console.log(angleObj%180 + " " + angleRob%180);
                            if ((angleRob%180) > (angleObj%180) + 10){
                                msg = 'L';
                            } else if ((angleRob%180) < (angleObj%180) - 10) {
                                msg = 'R';
                            } else if (objX > blob1.getScreenX(screenW) && objX > blob2.getScreenX(screenW)) {
                                if (blob1.getScreenX(screenW) > blob2.getScreenX(screenW)) {
                                    msg = 'F';
                                } else {
                                    msg = 'B';
                                }
                            } else if (objX < blob1.getScreenX(screenW) && objX < blob2.getScreenX(screenW)) {
                                if (blob1.getScreenX(screenW) > blob2.getScreenX(screenW)) {
                                    msg = 'B';
                                } else {
                                    msg = 'F';
                                }
                            }

                            if (objX > blob1.getScreenX(screenW) && objX < blob2.getScreenX(screenW)) {
                                if (objY > blob1.getScreenY(screenH) && objY < blob2.getScreenY(screenH)) {
                                    msg = 'S';
                                } else if (objY < blob1.getScreenY(screenH) && objY > blob2.getScreenY(screenH)) {
                                    msg = 'S';
                                }
                            } else if (objX < blob1.getScreenX(screenW) && objX > blob2.getScreenX(screenW)) {
                                if (objY > blob1.getScreenY(screenH) && objY < blob2.getScreenY(screenH)) {
                                    msg = 'S';
                                } else if (objY < blob1.getScreenY(screenH) && objY > blob2.getScreenY(screenH)) {
                                    msg = 'S';
                                }
                            }

                            if (Math.abs(XBarycentre - objX) < 100 && Math.abs(YBarycentre - objY) < 100) {
                                msg = 'S';
                            }

                            socket.emit(msg, "");

                            if (blob1.getScreenX(screenW) > blob2.getScreenX(screenW)) {

                            } else {

                            }
                        } else {
                            blob1.setColor("#FFFFFF");
                            blob2.setColor("#FFFF00");
                            if (blob2.getScreenX(screenW) == blob1.getScreenX(screenW)) {
                                angleRob = 0;
                            } else {
                                angleRob = Math.atan((blob2.getScreenY(screenH) - blob1.getScreenY(screenH)) / (blob1.getScreenX(screenW) - blob2.getScreenX(screenW))) / Math.PI * 180; 
                            }

                            console.log(angleObj%180 + " " + angleRob%180);
                            wheelAngle = angleRob;

                            if ((angleRob%180) > (angleObj%180) + 10){
                                msg = 'L';
                            } else if ((angleRob%180) < (angleObj%180) - 10) {
                                msg = 'R';
                            } else if (objX > blob1.getScreenX(screenW) && objX > blob2.getScreenX(screenW)) {
                                if (blob1.getScreenX(screenW) > blob2.getScreenX(screenW)) {
                                    msg = 'B';
                                } else {
                                    msg = 'F';
                                }
                            } else if (objX < blob1.getScreenX(screenW) && objX < blob2.getScreenX(screenW)) {
                                if (blob1.getScreenX(screenW) > blob2.getScreenX(screenW)) {
                                    msg = 'F';
                                } else {
                                    msg = 'B';
                                }
                            }

                            if (objX > blob1.getScreenX(screenW) && objX < blob2.getScreenX(screenW)) {
                                if (objY > blob1.getScreenY(screenH) && objY < blob2.getScreenY(screenH)) {
                                    msg = 'S';
                                } else if (objY < blob1.getScreenY(screenH) && objY > blob2.getScreenY(screenH)) {
                                    msg = 'S';
                                }
                            } else if (objX < blob1.getScreenX(screenW) && objX > blob2.getScreenX(screenW)) {
                                if (objY > blob1.getScreenY(screenH) && objY < blob2.getScreenY(screenH)) {
                                    msg = 'S';
                                } else if (objY < blob1.getScreenY(screenH) && objY > blob2.getScreenY(screenH)) {
                                    msg = 'S';
                                }
                            }
                            socket.emit(msg, "");
                        }

                        if (wheelPosX1 == -1) {
                            wheelPosX1 = XBarycentre + Math.sin(wheelAngle) * 30;
                        }  

                        if (wheelPosX2 == -1) {
                            wheelPosX2 = XBarycentre - Math.sin(wheelAngle) * 30;
                        }    

                        if (wheelPosY1 == -1) {
                            wheelPosY1 = YBarycentre + Math.cos(wheelAngle) * 30;
                        }  

                        if (wheelPosY2 == -1) {
                            wheelPosY2 = YBarycentre - Math.cos(wheelAngle) * 30;
                        }


                        wheelAngle = wheelAngle / 180 * Math.PI;
                        contextBackground.save();
                        contextBackground.strokeStyle = "#0000FF";
                        contextBackground.beginPath();
                        contextBackground.moveTo(wheelPosX1 ,wheelPosY1);
                        contextBackground.lineTo(XBarycentre + Math.sin(wheelAngle) * 60, YBarycentre + Math.cos(wheelAngle) * 60);
                        contextBackground.stroke();
                        contextBackground.restore();

                        contextBackground.save();
                        contextBackground.strokeStyle = "#0000FF";
                        contextBackground.beginPath();
                        contextBackground.moveTo(wheelPosX2 ,wheelPosY2);
                        contextBackground.lineTo(XBarycentre - Math.sin(wheelAngle) * 60, YBarycentre - Math.cos(wheelAngle) * 60);
                        contextBackground.stroke();
                        contextBackground.restore();

                        wheelPosX1 = XBarycentre + Math.sin(wheelAngle) * 60;
                        wheelPosY1 = YBarycentre + Math.cos(wheelAngle) * 60;
                        wheelPosX2 = XBarycentre - Math.sin(wheelAngle) * 60;
                        wheelPosY2 = YBarycentre - Math.cos(wheelAngle) * 60;
                    }

                    contextForeground.save();
                    contextForeground.translate(objX, objY);
                    contextForeground.fillStyle = "#00FF00";
                    contextForeground.fillRect(-20, -20, 20 , 20);
                    contextForeground.restore();

                    manager.drawBlobs(blobs);
                    
                },

                // Refresh the screen
                onRefresh = function(time) {
                    draw();
                },

                // New blob event
                onAddTuioBlob = function(blb) {
                    manager.addEvent(blb);
                },

                // Removed blob event
                onRemoveTuioBlob = function(blb) {
                    manager.removeEvent(blb);
                },

                // Updated blob event
                onUpdateTuioBlob = function(blb) {
                    manager.updateEvent(blb);
                };

                client.on("connect", onConnect);
                client.on("addTuioBlob", onAddTuioBlob);
                client.on("updateTuioBlob", onUpdateTuioBlob);
                client.on("removeTuioBlob", onRemoveTuioBlob);
                client.on("refresh", onRefresh);
                client.connect();
            });
        </script>
    </body>
</html>
